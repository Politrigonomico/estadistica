<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulaci√≥n de Carrera de Caballos - An√°lisis Probabil√≠stico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes gallop {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        .horse-running {
            animation: gallop 0.3s infinite;
        }
        
        @keyframes finish-celebration {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .winner-celebration {
            animation: finish-celebration 0.5s ease-in-out 3;
        }
        
        .track-line {
            background: repeating-linear-gradient(
                90deg,
                #e5e7eb 0px,
                #e5e7eb 20px,
                transparent 20px,
                transparent 40px
            );
        }
        
        .finish-line {
            background: repeating-linear-gradient(
                90deg,
                #000 0px,
                #000 10px,
                #fff 10px,
                #fff 20px
            );
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üèá Simulaci√≥n de Carrera de Caballos</h1>
            <p class="text-lg text-gray-600">An√°lisis Probabil√≠stico en Tiempo Real - ISP N¬∞21</p>
            <p class="text-sm text-gray-500 mt-2">Franco Leguizam√≥n & Ever Robledo - 2025</p>
        </div>

        <!-- Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-center">
                <button id="startRace" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition transform hover:scale-105">
                    üèÅ Iniciar Carrera
                </button>
                <button id="resetRace" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg transition">
                    üîÑ Reiniciar
                </button>
                <div class="flex items-center gap-2">
                    <label class="text-gray-700 font-semibold">Velocidad:</label>
                    <select id="speedControl" class="border border-gray-300 rounded-lg px-4 py-2">
                        <option value="3000">Lenta</option>
                        <option value="1500" selected>Normal</option>
                        <option value="500">R√°pida</option>
                        <option value="100">Muy R√°pida</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Weather and Conditions -->
        <div id="conditions" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üå§Ô∏è Condiciones de la Carrera</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-3xl mb-2" id="weatherIcon">‚òÄÔ∏è</div>
                    <div class="font-bold text-lg" id="weatherText">Soleado</div>
                    <div class="text-sm text-gray-600" id="weatherProb">Probabilidad: 60%</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-3xl mb-2">üèüÔ∏è</div>
                    <div class="font-bold text-lg">Terreno de C√©sped</div>
                    <div class="text-sm text-gray-600">Distancia: 2000m</div>
                </div>
                <div class="text-center p-4 bg-yellow-50 rounded-lg">
                    <div class="text-3xl mb-2">üèá</div>
                    <div class="font-bold text-lg">16 Competidores</div>
                    <div class="text-sm text-gray-600">Carrera Profesional</div>
                </div>
            </div>
        </div>

        <!-- Race Track -->
        <div id="raceTrack" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <div class="relative">
                <!-- Finish Line -->
                <div class="finish-line h-full w-2 absolute right-0 top-0 bottom-0"></div>
                
                <!-- Horses Container -->
                <div id="horsesContainer" class="space-y-1">
                    <!-- Horses will be added here dynamically -->
                </div>
                
                <!-- Progress indicator -->
                <div class="mt-4 text-center text-sm text-gray-600">
                    <span id="raceProgress">0%</span> completado
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div id="resultsPanel" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <h2 class="text-3xl font-bold text-center mb-6 text-green-600">üèÜ Resultados de la Carrera</h2>
            
            <!-- Winner Display -->
            <div id="winnerDisplay" class="bg-gradient-to-r from-yellow-100 to-yellow-50 rounded-lg p-6 mb-6 border-4 border-yellow-400">
                <!-- Winner info will be inserted here -->
            </div>

            <!-- Probability Calculations -->
            <div class="bg-blue-50 rounded-lg p-6 mb-6">
                <h3 class="text-2xl font-bold text-blue-800 mb-4">üìä An√°lisis Probabil√≠stico Completo</h3>
                <div id="probabilityCalculations" class="space-y-4">
                    <!-- Calculations will be inserted here -->
                </div>
            </div>

            <!-- Final Ranking -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">ü•á Clasificaci√≥n Final</h3>
                <div id="finalRanking" class="space-y-2">
                    <!-- Ranking will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Horse Information Panel -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">üìã Informaci√≥n de los Competidores</h3>
            <div id="horseInfoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Horse info cards will be added here -->
            </div>
        </div>

        <!-- Formulas Reference -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">üßÆ F√≥rmulas Utilizadas</h3>
            <div class="space-y-4 text-gray-700">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-bold mb-2">Probabilidad Base Ajustada:</h4>
                    <code class="block bg-white p-2 rounded">P(V)·µ¢ = WinRate·µ¢ √ó FactorEdad √ó FactorDupla</code>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-bold mb-2">Probabilidad Total:</h4>
                    <code class="block bg-white p-2 rounded">P(Victoria) = P(Soleado)√óP(V|Soleado) + P(Nublado)√óP(V|Nublado) + P(Lluvia)√óP(V|Lluvia)</code>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h4 class="font-bold mb-2">Teorema de Bayes:</h4>
                    <code class="block bg-white p-2 rounded">P(Clima|Gan√≥) = [P(Clima) √ó P(Gan√≥|Clima)] / P(Gan√≥)</code>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Horse Database
        const horses = [
            {
                id: 1, name: "RAYO VELOZ", emoji: "‚ö°", color: "yellow",
                age: 5, weight: 495, winRate: 0.32,
                specialty: "Terreno seco, c√©sped",
                rainPerformance: -0.35, hillPerformance: 0.05,
                jockey: "Mar√≠a Gonz√°lez", jockeyExp: 6, racesTogether: 15
            },
            {
                id: 2, name: "TRUENO OSCURO", emoji: "‚ö´", color: "gray",
                age: 6, weight: 510, winRate: 0.28,
                specialty: "Terreno embarrado, tierra",
                rainPerformance: 0.25, hillPerformance: 0.12,
                jockey: "Carlos M√©ndez", jockeyExp: 8, racesTogether: 22
            },
            {
                id: 3, name: "ESTRELLA DORADA", emoji: "‚≠ê", color: "yellow",
                age: 4, weight: 475, winRate: 0.18,
                specialty: "Velocidad punta, rectas largas",
                rainPerformance: -0.15, hillPerformance: -0.05,
                jockey: "Ana Rodr√≠guez", jockeyExp: 4, racesTogether: 8
            },
            {
                id: 4, name: "VIENTO DEL SUR", emoji: "üí®", color: "blue",
                age: 7, weight: 525, winRate: 0.25,
                specialty: "Resistencia, carreras largas",
                rainPerformance: 0, hillPerformance: 0.15,
                jockey: "Pedro S√°nchez", jockeyExp: 10, racesTogether: 30
            },
            {
                id: 5, name: "SOMBRA PLATEADA", emoji: "üåô", color: "gray",
                age: 5, weight: 488, winRate: 0.22,
                specialty: "Balance general, vers√°til",
                rainPerformance: -0.08, hillPerformance: 0.03,
                jockey: "Laura Fern√°ndez", jockeyExp: 5, racesTogether: 12
            },
            {
                id: 6, name: "FUEGO CARMES√ç", emoji: "üî•", color: "red",
                age: 6, weight: 502, winRate: 0.30,
                specialty: "C√©sped h√∫medo, sprint final",
                rainPerformance: 0.10, hillPerformance: 0.05,
                jockey: "Roberto D√≠az", jockeyExp: 7, racesTogether: 18
            },
            {
                id: 7, name: "NUBE GRIS", emoji: "‚òÅÔ∏è", color: "gray",
                age: 4, weight: 470, winRate: 0.15,
                specialty: "Velocidad inicial, desarrollo",
                rainPerformance: -0.10, hillPerformance: 0,
                jockey: "Sof√≠a Mart√≠nez", jockeyExp: 3, racesTogether: 5
            },
            {
                id: 8, name: "TORNADO AZUL", emoji: "üåÄ", color: "blue",
                age: 7, weight: 518, winRate: 0.27,
                specialty: "Todo terreno, constante",
                rainPerformance: 0.05, hillPerformance: 0.08,
                jockey: "Diego Torres", jockeyExp: 9, racesTogether: 25
            },
            {
                id: 9, name: "REL√ÅMPAGO NEGRO", emoji: "‚ö°", color: "black",
                age: 5, weight: 492, winRate: 0.24,
                specialty: "Aceleraci√≥n en curvas",
                rainPerformance: -0.05, hillPerformance: 0.07,
                jockey: "Carmen L√≥pez", jockeyExp: 6, racesTogether: 14
            },
            {
                id: 10, name: "DIAMANTE BLANCO", emoji: "üíé", color: "white",
                age: 6, weight: 507, winRate: 0.29,
                specialty: "Terreno seco, potencia",
                rainPerformance: -0.20, hillPerformance: 0.10,
                jockey: "Manuel Ruiz", jockeyExp: 8, racesTogether: 20
            },
            {
                id: 11, name: "COMETA ROJO", emoji: "‚òÑÔ∏è", color: "red",
                age: 4, weight: 478, winRate: 0.16,
                specialty: "Alta velocidad, poca resistencia",
                rainPerformance: -0.12, hillPerformance: -0.08,
                jockey: "Patricia Vega", jockeyExp: 4, racesTogether: 7
            },
            {
                id: 12, name: "LUNA CRECIENTE", emoji: "üåô", color: "silver",
                age: 8, weight: 530, winRate: 0.20,
                specialty: "Veterano, gesti√≥n t√°ctica",
                rainPerformance: 0, hillPerformance: 0.05,
                jockey: "Andr√©s Silva", jockeyExp: 12, racesTogether: 35
            },
            {
                id: 13, name: "SOL RADIANTE", emoji: "‚òÄÔ∏è", color: "orange",
                age: 5, weight: 498, winRate: 0.26,
                specialty: "D√≠as soleados",
                rainPerformance: -0.25, hillPerformance: 0.04,
                jockey: "Isabel Moreno", jockeyExp: 7, racesTogether: 16
            },
            {
                id: 14, name: "CASCADA CRISTALINA", emoji: "üíß", color: "cyan",
                age: 6, weight: 515, winRate: 0.23,
                specialty: "Terreno mojado, bajadas",
                rainPerformance: 0.15, hillPerformance: 0.12,
                jockey: "Felipe Castro", jockeyExp: 6, racesTogether: 13
            },
            {
                id: 15, name: "HALC√ìN DORADO", emoji: "ü¶Ö", color: "gold",
                age: 5, weight: 485, winRate: 0.21,
                specialty: "Estratega, timing perfecto",
                rainPerformance: -0.05, hillPerformance: 0.06,
                jockey: "Ver√≥nica Paz", jockeyExp: 5, racesTogether: 11
            },
            {
                id: 16, name: "TORMENTA P√öRPURA", emoji: "üå©Ô∏è", color: "purple",
                age: 7, weight: 522, winRate: 0.19,
                specialty: "Fondo poderoso, √∫ltimos 400m",
                rainPerformance: 0.08, hillPerformance: 0.09,
                jockey: "Ricardo Navarro", jockeyExp: 8, racesTogether: 19
            }
        ];

        // Weather conditions
        const weatherConditions = [
            { type: "sunny", name: "Soleado", icon: "‚òÄÔ∏è", probability: 0.60, grassMultiplier: 1.15, mudMultiplier: 1.0 },
            { type: "cloudy", name: "Nublado", icon: "‚òÅÔ∏è", probability: 0.15, grassMultiplier: 1.0, mudMultiplier: 1.0 },
            { type: "rainy", name: "Lluvioso", icon: "üåßÔ∏è", probability: 0.25, grassMultiplier: 0.65, mudMultiplier: 1.25 }
        ];

        // Race state
        let raceInProgress = false;
        let currentWeather = null;
        let raceResults = [];
        let raceSpeed = 1500;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            createHorseInfoCards();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('startRace').addEventListener('click', startRace);
            document.getElementById('resetRace').addEventListener('click', resetRace);
            document.getElementById('speedControl').addEventListener('change', function(e) {
                raceSpeed = parseInt(e.target.value);
            });
        }

        function createHorseInfoCards() {
            const grid = document.getElementById('horseInfoGrid');
            horses.forEach(horse => {
                const card = document.createElement('div');
                card.className = 'bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-lg border-2 border-gray-200 hover:border-blue-400 transition';
                card.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">${horse.emoji}</span>
                        <h4 class="font-bold text-sm">${horse.name}</h4>
                    </div>
                    <div class="text-xs space-y-1 text-gray-600">
                        <p><strong>Win Rate:</strong> ${(horse.winRate * 100).toFixed(0)}%</p>
                        <p><strong>Edad:</strong> ${horse.age} a√±os</p>
                        <p><strong>Peso:</strong> ${horse.weight} kg</p>
                        <p><strong>Jockey:</strong> ${horse.jockey}</p>
                        <p><strong>Especialidad:</strong> ${horse.specialty}</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function getAgeFactor(age) {
            if (age >= 5 && age <= 7) return 1.05; // Prime
            if (age >= 3 && age <= 4) return 0.95; // Young
            return 0.90; // Veteran
        }

        function getDuplaFactor(racesTogether) {
            if (racesTogether > 10) return 1.10;
            if (racesTogether >= 3) return 1.00;
            return 0.90;
        }

        function calculateBaseProbability(horse) {
            const ageFactor = getAgeFactor(horse.age);
            const duplaFactor = getDuplaFactor(horse.racesTogether);
            return horse.winRate * ageFactor * duplaFactor;
        }

        function calculateWeatherAdjustedProb(horse, weather) {
            const baseProb = calculateBaseProbability(horse);
            let weatherMultiplier = 1.0;

            if (weather.type === "sunny") {
                weatherMultiplier = horse.rainPerformance < 0 ? weather.grassMultiplier : 1.0;
            } else if (weather.type === "rainy") {
                weatherMultiplier = horse.rainPerformance > 0 ? weather.mudMultiplier : weather.grassMultiplier;
            }

            return baseProb * weatherMultiplier;
        }

        function selectRandomWeather() {
            const rand = Math.random();
            let cumulative = 0;
            for (const weather of weatherConditions) {
                cumulative += weather.probability;
                if (rand <= cumulative) {
                    return weather;
                }
            }
            return weatherConditions[0];
        }

        function startRace() {
            if (raceInProgress) return;
            
            raceInProgress = true;
            document.getElementById('startRace').disabled = true;
            document.getElementById('resultsPanel').classList.add('hidden');
            
            // Select weather
            currentWeather = selectRandomWeather();
            
            // Show conditions
            document.getElementById('conditions').classList.remove('hidden');
            document.getElementById('weatherIcon').textContent = currentWeather.icon;
            document.getElementById('weatherText').textContent = currentWeather.name;
            document.getElementById('weatherProb').textContent = `Probabilidad: ${(currentWeather.probability * 100)}%`;
            
            // Calculate probabilities for all horses
            const horsesWithProbs = horses.map(horse => ({
                ...horse,
                baseProb: calculateBaseProbability(horse),
                adjustedProb: calculateWeatherAdjustedProb(horse, currentWeather),
                // Add some randomness for simulation
                finalTime: 124 + (Math.random() * 10 - 5) // Base time 124s ¬± 5s
            }));

            // Normalize probabilities and add randomness
            horsesWithProbs.forEach(horse => {
                const randomFactor = 0.7 + (Math.random() * 0.6); // 0.7 to 1.3
                horse.raceSpeed = horse.adjustedProb * randomFactor;
            });

            // Create race track
            createRaceTrack(horsesWithProbs);
            
            // Simulate race
            setTimeout(() => simulateRace(horsesWithProbs), 500);
        }

        function createRaceTrack(horsesData) {
            const container = document.getElementById('horsesContainer');
            container.innerHTML = '';
            document.getElementById('raceTrack').classList.remove('hidden');

            horsesData.forEach((horse, index) => {
                const horseElement = document.createElement('div');
                horseElement.className = 'relative flex items-center py-2 border-b border-gray-200';
                horseElement.innerHTML = `
                    <div class="w-32 text-xs font-semibold truncate">${horse.emoji} ${horse.name}</div>
                    <div class="flex-1 relative h-8 bg-gray-100 rounded-full track-line">
                        <div id="horse-${horse.id}" class="horse-running absolute left-0 top-1/2 transform -translate-y-1/2 text-2xl transition-all duration-100">
                            ${horse.emoji}
                        </div>
                    </div>
                    <div class="w-20 text-xs text-right">
                        <span id="position-${horse.id}">-</span>
                    </div>
                `;
                container.appendChild(horseElement);
            });
        }

        function simulateRace(horsesData) {
            const duration = raceSpeed;
            const steps = 100;
            const interval = duration / steps;
            let currentStep = 0;

            const raceInterval = setInterval(() => {
                currentStep++;
                const progress = currentStep / steps;

                horsesData.forEach(horse => {
                    const horseEl = document.getElementById(`horse-${horse.id}`);
                    if (horseEl) {
                        // Calculate position with some randomness
                        const baseProgress = progress * horse.raceSpeed;
                        const randomness = Math.random() * 0.05;
                        const finalProgress = Math.min((baseProgress + randomness) * 100, 98);
                        horseEl.style.left = `${finalProgress}%`;
                    }
                });

                // Update progress
                document.getElementById('raceProgress').textContent = `${Math.round(progress * 100)}%`;

                if (currentStep >= steps) {
                    clearInterval(raceInterval);
                    finishRace(horsesData);
                }
            }, interval);
        }

        function finishRace(horsesData) {
            // Calculate final positions
            horsesData.sort((a, b) => b.raceSpeed - a.raceSpeed);
            
            horsesData.forEach((horse, index) => {
                const posEl = document.getElementById(`position-${horse.id}`);
                if (posEl) {
                    posEl.textContent = `${index + 1}¬∞`;
                }
                
                // Add winner celebration
                if (index === 0) {
                    const horseEl = document.getElementById(`horse-${horse.id}`);
                    if (horseEl) {
                        horseEl.classList.add('winner-celebration');
                        horseEl.style.left = '98%';
                    }
                }
            });

            raceResults = horsesData;
            
            setTimeout(() => {
                showResults();
            }, 1000);
        }

        function showResults() {
            const winner = raceResults[0];
            document.getElementById('resultsPanel').classList.remove('hidden');
            
            // Winner Display
            const winnerDisplay = document.getElementById('winnerDisplay');
            winnerDisplay.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">${winner.emoji}</div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-2">${winner.name}</h3>
                    <p class="text-xl text-gray-600 mb-4">¬°Ganador de la Carrera!</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div class="bg-white p-3 rounded">
                            <div class="font-bold text-gray-600">Win Rate Base</div>
                            <div class="text-2xl font-bold text-blue-600">${(winner.winRate * 100).toFixed(0)}%</div>
                        </div>
                        <div class="bg-white p-3 rounded">
                            <div class="font-bold text-gray-600">Edad</div>
                            <div class="text-2xl font-bold text-green-600">${winner.age} a√±os</div>
                        </div>
                        <div class="bg-white p-3 rounded">
                            <div class="font-bold text-gray-600">Jockey</div>
                            <div class="text-lg font-bold text-purple-600">${winner.jockey}</div>
                        </div>
                        <div class="bg-white p-3 rounded">
                            <div class="font-bold text-gray-600">Carreras Juntos</div>
                            <div class="text-2xl font-bold text-orange-600">${winner.racesTogether}</div>
                        </div>
                    </div>
                </div>
            `;

            // Probability Calculations
            showProbabilityCalculations(winner);
            
            // Final Ranking
            showFinalRanking();
            
            // Scroll to results
            document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            raceInProgress = false;
            document.getElementById('startRace').disabled = false;
        }

        function showProbabilityCalculations(winner) {
            const container = document.getElementById('probabilityCalculations');
            
            const ageFactor = getAgeFactor(winner.age);
            const duplaFactor = getDuplaFactor(winner.racesTogether);
            const baseProb = calculateBaseProbability(winner);
            const adjustedProb = calculateWeatherAdjustedProb(winner, currentWeather);

            // Calculate total probability across all weather conditions
            const probSunny = baseProb * (winner.rainPerformance < 0 ? 1.15 : 1.0);
            const probCloudy = baseProb * 1.0;
            const probRainy = baseProb * (winner.rainPerformance > 0 ? 1.25 : 0.65);
            const totalProb = (0.60 * probSunny) + (0.15 * probCloudy) + (0.25 * probRainy);

            // Bayes calculation
            let bayesProb = 0;
            if (currentWeather.type === "rainy") {
                bayesProb = (0.25 * probRainy) / totalProb;
            } else if (currentWeather.type === "sunny") {
                bayesProb = (0.60 * probSunny) / totalProb;
            } else {
                bayesProb = (0.15 * probCloudy) / totalProb;
            }

            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Step 1: Base Probability -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-xl font-bold text-blue-600 mb-3">üìê Paso 1: Probabilidad Base Ajustada</h4>
                        <div class="space-y-2 text-gray-700">
                            <p class="font-mono text-sm bg-gray-50 p-3 rounded">
                                P(Victoria) = WinRate √ó FactorEdad √ó FactorDupla
                            </p>
                            <p>‚Ä¢ <strong>Win Rate:</strong> ${(winner.winRate * 100).toFixed(0)}% = ${winner.winRate.toFixed(2)}</p>
                            <p>‚Ä¢ <strong>Factor Edad</strong> (${winner.age} a√±os - ${winner.age >= 5 && winner.age <= 7 ? 'Prime' : winner.age <= 4 ? 'Joven' : 'Veterano'}): ${ageFactor}</p>
                            <p>‚Ä¢ <strong>Factor Dupla</strong> (${winner.racesTogether} carreras juntos): ${duplaFactor}</p>
                            <div class="mt-3 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                <p class="font-bold">C√°lculo:</p>
                                <p class="font-mono">${winner.winRate.toFixed(2)} √ó ${ageFactor} √ó ${duplaFactor} = ${baseProb.toFixed(4)}</p>
                                <p class="text-xl font-bold text-blue-600 mt-2">Probabilidad Base: ${(baseProb * 100).toFixed(2)}%</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Weather Adjustment -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-xl font-bold text-green-600 mb-3">üå§Ô∏è Paso 2: Ajuste por Condiciones Clim√°ticas</h4>
                        <div class="space-y-2 text-gray-700">
                            <p><strong>Clima actual:</strong> ${currentWeather.name} ${currentWeather.icon}</p>
                            <p><strong>Especialidad del caballo:</strong> ${winner.specialty}</p>
                            <p><strong>Rendimiento en lluvia:</strong> ${winner.rainPerformance > 0 ? '+' : ''}${(winner.rainPerformance * 100).toFixed(0)}%</p>
                            
                            ${currentWeather.type === 'sunny' ? `
                                <p class="mt-2">Como est√° <strong>soleado</strong> y el caballo ${winner.rainPerformance < 0 ? 'se especializa en terreno seco' : 'tiene buen rendimiento general'}:</p>
                                <p class="font-mono bg-gray-50 p-2 rounded">Multiplicador = ${winner.rainPerformance < 0 ? currentWeather.grassMultiplier : 1.0}</p>
                            ` : currentWeather.type === 'rainy' ? `
                                <p class="mt-2">Como est√° <strong>lloviendo</strong> y el caballo ${winner.rainPerformance > 0 ? 'se especializa en barro' : 'prefiere terreno seco'}:</p>
                                <p class="font-mono bg-gray-50 p-2 rounded">Multiplicador = ${winner.rainPerformance > 0 ? currentWeather.mudMultiplier : currentWeather.grassMultiplier}</p>
                            ` : `
                                <p class="mt-2">Como est√° <strong>nublado</strong> (condiciones neutras):</p>
                                <p class="font-mono bg-gray-50 p-2 rounded">Multiplicador = 1.0</p>
                            `}
                            
                            <div class="mt-3 p-4 bg-green-50 rounded-lg border-2 border-green-200">
                                <p class="font-bold">C√°lculo Ajustado:</p>
                                <p class="font-mono">${(baseProb * 100).toFixed(2)}% √ó ${(adjustedProb / baseProb).toFixed(2)} = ${(adjustedProb * 100).toFixed(2)}%</p>
                                <p class="text-xl font-bold text-green-600 mt-2">Probabilidad Ajustada: ${(adjustedProb * 100).toFixed(2)}%</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Total Probability -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-xl font-bold text-purple-600 mb-3">üìä Paso 3: Teorema de Probabilidad Total</h4>
                        <div class="space-y-2 text-gray-700">
                            <p>Considerando <strong>todos los escenarios clim√°ticos</strong> posibles:</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 my-3">
                                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                                    <p class="font-bold">‚òÄÔ∏è Soleado (60%)</p>
                                    <p class="text-sm">${(probSunny * 100).toFixed(2)}%</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                    <p class="font-bold">‚òÅÔ∏è Nublado (15%)</p>
                                    <p class="text-sm">${(probCloudy * 100).toFixed(2)}%</p>
                                </div>
                                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                    <p class="font-bold">üåßÔ∏è Lluvia (25%)</p>
                                    <p class="text-sm">${(probRainy * 100).toFixed(2)}%</p>
                                </div>
                            </div>
                            <p class="font-mono text-sm bg-gray-50 p-3 rounded">
                                P(Victoria Total) = 0.60√ó${(probSunny * 100).toFixed(2)}% + 0.15√ó${(probCloudy * 100).toFixed(2)}% + 0.25√ó${(probRainy * 100).toFixed(2)}%
                            </p>
                            <div class="mt-3 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
                                <p class="font-bold">C√°lculo:</p>
                                <p class="font-mono">${(0.60 * probSunny).toFixed(4)} + ${(0.15 * probCloudy).toFixed(4)} + ${(0.25 * probRainy).toFixed(4)} = ${totalProb.toFixed(4)}</p>
                                <p class="text-xl font-bold text-purple-600 mt-2">Probabilidad Total: ${(totalProb * 100).toFixed(2)}%</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Bayes -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h4 class="text-xl font-bold text-red-600 mb-3">üîÑ Paso 4: Teorema de Bayes</h4>
                        <div class="space-y-2 text-gray-700">
                            <p class="italic">Pregunta: Si ${winner.name} gan√≥, ¬øcu√°l es la probabilidad de que el clima fuera ${currentWeather.name}?</p>
                            <p class="font-mono text-sm bg-gray-50 p-3 rounded mt-3">
                                P(${currentWeather.name}|Gan√≥) = [P(${currentWeather.name}) √ó P(Gan√≥|${currentWeather.name})] / P(Gan√≥)
                            </p>
                            <p class="mt-2">‚Ä¢ <strong>P(${currentWeather.name}):</strong> ${(currentWeather.probability * 100)}%</p>
                            <p>‚Ä¢ <strong>P(Gan√≥|${currentWeather.name}):</strong> ${(adjustedProb * 100).toFixed(2)}%</p>
                            <p>‚Ä¢ <strong>P(Gan√≥):</strong> ${(totalProb * 100).toFixed(2)}%</p>
                            <div class="mt-3 p-4 bg-red-50 rounded-lg border-2 border-red-200">
                                <p class="font-bold">C√°lculo de Bayes:</p>
                                <p class="font-mono">(${currentWeather.probability} √ó ${adjustedProb.toFixed(4)}) / ${totalProb.toFixed(4)} = ${bayesProb.toFixed(4)}</p>
                                <p class="text-xl font-bold text-red-600 mt-2">Probabilidad Bayesiana: ${(bayesProb * 100).toFixed(1)}%</p>
                                <p class="mt-2 text-sm">
                                    ${bayesProb > currentWeather.probability ? 
                                        `‚úÖ La victoria de ${winner.name} <strong>aumenta</strong> la probabilidad de que fuera ${currentWeather.name} (de ${(currentWeather.probability * 100)}% a ${(bayesProb * 100).toFixed(1)}%)` : 
                                        `‚ö†Ô∏è La probabilidad de ${currentWeather.name} es similar a la esperada`
                                    }
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg shadow-lg border-2 border-green-300">
                        <h4 class="text-xl font-bold text-gray-800 mb-3">üìù Resumen del An√°lisis</h4>
                        <div class="space-y-2 text-gray-700">
                            <p>‚úÖ <strong>${winner.name}</strong> ten√≠a una probabilidad total de victoria del <strong>${(totalProb * 100).toFixed(2)}%</strong></p>
                            <p>‚úÖ Con el clima ${currentWeather.name}, su probabilidad ajustada era <strong>${(adjustedProb * 100).toFixed(2)}%</strong></p>
                            <p>‚úÖ Los factores clave fueron: ${winner.age >= 5 && winner.age <= 7 ? 'edad √≥ptima (+5%)' : ''}, ${winner.racesTogether > 10 ? 'excelente qu√≠mica con el jockey (+10%)' : ''}, ${currentWeather.type === 'rainy' && winner.rainPerformance > 0 ? 'especialista en lluvia (+25%)' : currentWeather.type === 'sunny' && winner.rainPerformance < 0 ? 'especialista en terreno seco (+15%)' : 'buenas condiciones generales'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function showFinalRanking() {
            const container = document.getElementById('finalRanking');
            container.innerHTML = raceResults.map((horse, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∞`;
                return `
                    <div class="flex items-center gap-4 p-3 rounded-lg ${index < 3 ? 'bg-yellow-50 border-2 border-yellow-300' : 'bg-gray-50'}">
                        <div class="text-2xl w-12 text-center font-bold">${medal}</div>
                        <div class="text-2xl">${horse.emoji}</div>
                        <div class="flex-1">
                            <div class="font-bold">${horse.name}</div>
                            <div class="text-xs text-gray-600">
                                Base: ${(horse.baseProb * 100).toFixed(1)}% | 
                                Ajustado: ${(horse.adjustedProb * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function resetRace() {
            raceInProgress = false;
            document.getElementById('startRace').disabled = false;
            document.getElementById('conditions').classList.add('hidden');
            document.getElementById('raceTrack').classList.add('hidden');
            document.getElementById('resultsPanel').classList.add('hidden');
            document.getElementById('horsesContainer').innerHTML = '';
            raceResults = [];
            currentWeather = null;
        }
    </script>
</body>
</html>